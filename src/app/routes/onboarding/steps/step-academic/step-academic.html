<div class="step-container">
  <div class="step-header">
    <div class="step-icon-badge">üéì</div>
    <h2 class="step-title">Academic Information</h2>
    <p class="step-desc">Add all your academic qualifications ‚Äî you can add multiple degrees</p>
  </div>

  <div class="degree-section">
    <!-- ‚îÄ‚îÄ Saved degree cards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    @if (degrees.length > 0) {
      <div class="degrees-list">
        @for (deg of degrees; track deg; let i = $index) {
          <div class="degree-card">
            <div class="degree-card__icon">üèõÔ∏è</div>
            <div class="degree-card__body">
              <span class="degree-card__program">
                {{ deg.degree }}
              </span>
              <span class="degree-card__institution">
                {{ deg.institution }}
              </span>
              <div class="degree-card__meta">
                <span class="degree-card__tag">{{ isHighSchool ? deg.grades : deg.major }}</span>
                <span class="degree-card__tag">Year: {{ deg.yearBatch }}</span>
                @if (deg.degreeFileUrl) {
                  <span class="degree-card__tag degree-card__tag--file">
                    <mat-icon style="font-size: 13px; width: 13px; height: 13px">
                      attach_file
                    </mat-icon>
                    {{ deg.degreeFileUrl }}
                  </span>
                }
              </div>
            </div>
            <div class="degree-card__actions">
              <button type="button" class="degree-icon-btn" (click)="editDegree(i)" title="Edit">
                <mat-icon>edit</mat-icon>
              </button>
              <button
                type="button"
                class="degree-icon-btn degree-icon-btn--remove"
                (click)="removeDegree(i)"
                title="Remove"
              >
                <mat-icon>delete_outline</mat-icon>
              </button>
            </div>
          </div>
        }
      </div>
    }

    <!-- ‚îÄ‚îÄ "Add Another" button ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    @if (!showDegreeForm && degrees.length > 0) {
      <button type="button" class="add-degree-btn" (click)="openAddDegree()">
        <mat-icon>add_circle_outline</mat-icon>
        Add Another Degree
      </button>
    }

    <!-- ‚îÄ‚îÄ Inline degree form ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    @if (showDegreeForm) {
      <div class="degree-form-panel">
        <div class="degree-form-panel__header">
          <mat-icon>school</mat-icon>
          <span>
            {{
              editingIndex >= 0
                ? 'Edit Degree'
                : degrees.length > 0
                  ? 'Add Another Degree'
                  : 'Degree Details'
            }}
          </span>
        </div>

        <form [formGroup]="degreeForm" class="step-form" style="gap: 6px">
          <!-- Institution / School -->
          <div class="form-row">
            <mat-form-field appearance="outline" class="step-field">
              <mat-label>
                {{ isHighSchool ? 'Institution / School' : 'Institution / University' }}
              </mat-label>
              <mat-select formControlName="institution">
                @for (inst of institutions$ | async; track inst) {
                  <mat-option [value]="inst">{{ inst }}</mat-option>
                }
              </mat-select>
              @if (
                degreeForm.get('institution')?.invalid && degreeForm.get('institution')?.touched
              ) {
                <mat-error>Required</mat-error>
              }
            </mat-form-field>
          </div>

          <div class="form-row two-cols">
            <!-- Degree / Certificate -->
            <mat-form-field appearance="outline" class="step-field">
              <mat-label>{{ isHighSchool ? 'Degree / Certificate' : 'Degree' }}</mat-label>
              @if (isHighSchool) {
                <mat-select formControlName="degree">
                  <mat-option value="Matriculation">Matriculation</mat-option>
                  <mat-option value="Intermediate">Intermediate</mat-option>
                  <mat-option value="O Levels">O Levels</mat-option>
                  <mat-option value="A Levels">A Levels</mat-option>
                  <mat-option value="Other">Other</mat-option>
                </mat-select>
              } @else {
                <mat-select formControlName="degree">
                  @for (d of degrees$ | async; track d) {
                    <mat-option [value]="d">{{ d }}</mat-option>
                  }
                </mat-select>
              }
              @if (degreeForm.get('degree')?.invalid && degreeForm.get('degree')?.touched) {
                <mat-error>Required</mat-error>
              }
            </mat-form-field>

            <!-- Year -->
            <mat-form-field appearance="outline" class="step-field">
              <mat-label>Year</mat-label>
              <mat-select formControlName="yearBatch">
                @for (b of isHighSchool ? highSchoolYears : batches; track b) {
                  <mat-option [value]="b.value">{{ b.label }}</mat-option>
                }
              </mat-select>
              @if (degreeForm.get('yearBatch')?.invalid && degreeForm.get('yearBatch')?.touched) {
                <mat-error>Required</mat-error>
              }
            </mat-form-field>
          </div>

          <div class="form-row two-cols">
            @if (isHighSchool) {
              <!-- Grades -->
              <mat-form-field appearance="outline" class="step-field">
                <mat-label>Grades / Percentage</mat-label>
                <input matInput formControlName="grades" placeholder="e.g. A Grade, 85%" />
                @if (degreeForm.get('grades')?.invalid && degreeForm.get('grades')?.touched) {
                  <mat-error>Required</mat-error>
                }
              </mat-form-field>

              <!-- Education System -->
              <mat-form-field appearance="outline" class="step-field">
                <mat-label>Education System</mat-label>
                <mat-select formControlName="educationSystem">
                  @for (es of educationSystems; track es) {
                    <mat-option [value]="es">{{ es }}</mat-option>
                  }
                </mat-select>
                @if (
                  degreeForm.get('educationSystem')?.invalid &&
                  degreeForm.get('educationSystem')?.touched
                ) {
                  <mat-error>Required</mat-error>
                }
              </mat-form-field>
            } @else {
              <!-- Major (University Only) -->
              <mat-form-field appearance="outline" class="step-field">
                <mat-label>Major / Field of Study</mat-label>
                <input matInput formControlName="major" placeholder="e.g. Computer Science" />
                @if (degreeForm.get('major')?.invalid && degreeForm.get('major')?.touched) {
                  <mat-error>Required</mat-error>
                }
              </mat-form-field>
            }
          </div>

          <!-- Degree Upload -->
          <div class="form-row">
            <label for="degree-certificate" class="field-label">
              Degree Certificate
              <span class="field-hint">(optional)</span>
            </label>
            <input
              id="degree-certificate"
              #fileInput
              type="file"
              accept=".pdf,.jpg,.jpeg,.png"
              class="file-input-hidden"
              (change)="onFileSelected($event)"
            />
            <div
              class="file-upload-area"
              (click)="triggerFileInput(fileInput)"
              (keyup.enter)="triggerFileInput(fileInput)"
              tabindex="0"
              [attr.for]="'degree-certificate'"
            >
              @if (selectedFile) {
                <mat-icon class="file-upload-area__icon file-upload-area__icon--ok">
                  check_circle
                </mat-icon>
                <span class="file-upload-area__name">{{ selectedFile.name }}</span>
              } @else {
                <mat-icon class="file-upload-area__icon">upload_file</mat-icon>
                <span class="file-upload-area__text">Click to upload PDF, JPG or PNG</span>
              }
            </div>
          </div>

          <!-- Form actions -->
          <div class="degree-form-actions">
            @if (degrees.length > 0 || editingIndex >= 0) {
              <button type="button" class="btn-cancel" (click)="cancelDegreeForm()">Cancel</button>
            }
            <button type="button" class="btn-add-degree" (click)="saveDegree()">
              <mat-icon>check</mat-icon>
              Save Degree
            </button>
          </div>
        </form>
      </div>
    }
  </div>

  <!-- Step navigation -->
  <div class="step-actions">
    <button type="button" matButton class="btn-back" (click)="back.emit()">
      <mat-icon>arrow_back</mat-icon>
      Back
    </button>
    <button
      type="button"
      matButton="filled"
      class="btn-next"
      [disabled]="degrees.length === 0 && degreeForm.invalid"
      (click)="submit()"
    >
      Continue
      <mat-icon>arrow_forward</mat-icon>
    </button>
  </div>
</div>
